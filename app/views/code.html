<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" type="text/css" href="/stylesheet/style.css">
    <title>Swap Coder</title>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.2.0/ace.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.2.0/ext-language_tools.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/processing.js/1.2.1/processing.min.js"></script>
    <script src="/js/func.js"></script>
    <script src="/js/easytimer.js"></script>
    <script src="/js/humane.min.js"></script>
    <script type="text/javascript" src="/socket.io/socket.io.js"></script>
</head>

<body>
    <h1 id="codeh1">Swap Coder</h1>
    <header>
        <!--言語入門サイトのリンク-->
        <div class="hamburger-menu">
            <input type="checkbox" id="menu-btn-check">
            <label for="menu-btn-check" class="menu-btn"><span></span></label>
            <!--ここからメニュー-->
            <div class="menu-content">
                <ul>
                    <li>
                        <a href="http://wisdom.sakura.ne.jp/programming/c/index.html" target="_blank">C言語入門サイト</a>
                    </li>
                    <li>
                        <a href="http://wisdom.sakura.ne.jp/programming/cpp/" target="_blank">C++入門サイト</a>
                    </li>
                    <li>
                        <a href="https://www.javadrive.jp/start/" target="_blank">Java入門サイト</a>
                    </li>
                    <li>
                        <a href="https://www.tohoho-web.com/python/" target="_blank">Python入門サイト</a>
                    </li>
                    <li>
                        <a href="https://www.javadrive.jp/ruby/" target="_blank">Ruby入門サイト</a>
                    </li>
                    <li>
                        <a href="https://www.javadrive.jp/php/" target="_blank">PHP入門サイト</a>
                    </li>
                    <li>
                        <a href="https://www.tohoho-web.com/ex/golang.html" target="_blank">Go言語入門サイト</a>
                    </li>
                    <li>
                        <a href="https://www.javadrive.jp/javascript/" target="_blank">Java script入門サイト</a>
                    </li>
                </ul>
            </div>
            <!--ここまでメニュー-->
        </div>
    </header>

    <table>
        <tr>
            <td>
                <!--タイマー-->
                <div id="timer">
                    <div id="swap">
                        <p>コード交換まで</p>
                        <div class="countdown">
                            <div id="swapTime">00:01:00</div>
                        </div>
                    </div>
                    <p>ゲーム終了まで</p>
                    <div class="countdown">
                        <div id="limitTime">01:00:00</div>
                    </div>
                </div>
            </td>
            <td>
                <!--サーバから問題文のテキストを受信して表示する-->
                <div id="question">
                    <h3 style="color: #E65F5C">課題</h2>
                        <!--ここにサーバから受信した課題文を表示-->
                        <div id="problemStatement"></div>
                </div>
            </td>
        </tr>
    </table>
    <table height=320px>
        <tr>
            <td>
                <div id="member">
                    <p>===メンバー===</p>
                </div>
                <input type=button onclick="start()" value="START" id="start">
                <!--<input type=button onclick="end()" value="END" id="end">-->
            </td>
            <td width=400px height=320px bgcolor=white>
                <p>input</p>
                <textarea height=100px id="input" bgcolor=gray></textarea>
                <p>output ※コンパイルに2秒程かかります。</p>
                <div style="white-space: pre-line" height=220px id="output" bgcolor=gray></div>
            </td>
            <!-- processing言語用
            <td width=400px height=320px bgcolor=white> 
                <canvas id="canvas0" width="320px" height="320px"></canvas>
            </td>-->
            <td width=600px>
                <div id="editor" style="height: 320px"></div>
                <div align=right>
                    <select name="language">
                        <option value="c_cpp">C</option>
                        <option value="c_cpp">C++</option>
                        <option value="java">Java</option>
                        <option value="python">Python</option>
                        <!--stdoutが表示されない-->
                        <option value="ruby">Ruby</option>
                        <!--stdoutが表示されない-->
                        <option value="php">PHP</option>
                        <!--stdoutが表示されない-->
                        <option value="go">Go</option>
                        <option value="javascript">Java Script</option>
                        <option value="rust">Rust</option>
                        <option value="kotlin">Kotlin</option>
                        <option value="scala">Scala</option>
                        <option value="swift">Swift</option>
                        <option value="objectivec">Objective-C</option>
                        <option value="typescript">Type Script</option>
                    </select>
                    <input type=button onclick="run()" value="RUN">
                    <input type=button onclick="submit()" value="SUBMIT">
                    <!--<input type=button onclick="stop()" value="STOP">-->
                    <!--processing言語用-->
                </div>
            </td>
        </tr>
    </table>


    <script type="text/javascript">
        // 問題文・交換タイマー非表示
        $("#question").hide();
        $("#swap").hide();

        // aceエディター設定
        const editor = ace.edit('editor');
        editor.setTheme("ace/theme/monokai");
        editor.getSession().setMode("ace/mode/c_cpp");
        // editor.setValue("new here code");
        editor.setOptions({
            enableBasicAutocompletion: true,
            enableSnippets: true,
            enableLiveAutocompletion: true
        });

        let temps; // 言語別コードテンプレート格納変数

        // 言語選択によるaceエディタ言語変更処理
        let select = document.querySelector('[name="language"]');
        select.onchange = event => {
            editor.getSession().setMode("ace/mode/" + select.value);
            editor.setValue(temps[select.selectedIndex]);
        };

        // コード実行
        async function run() {
            const code = editor.getValue();
            const input = document.getElementById("input").value;

            let result = await compile(code, select.selectedIndex, input);
            $('#output').text(result);
        };

        // ソケット通信
        const socket = io("/play");
        let myData; // 自分の名前,id,socketId,言語,codeを保持
        let question; // 課題情報格納変数

        // aceエディタ言語設定処理
        function lang_selectOrChange(num) {
            myData.lang = num;
            let option = document.querySelectorAll('select[name=language] option');
            for (let i = 0; i < select.childElementCount; i++) {
                if (num == i) {
                    option[i].selected = true;
                } else {
                    option[i].disabled = true;
                }
            }
        };

        // ソケット接続時処理、既に参加しているメンバーの表示(自分も含む)
        socket.on("server_to_client_member", function (data) {
            for (const member of data) {
                $("#member").append("<div>" + member.name + "</div>");
            };
            myData = data[data.length - 1];
        });

        // 言語別コードテンプレート取得
        socket.on("server_to_client_template", function(data){
            temps = data;
            editor.setValue(temps[0]); // デフォルト、C言語テンプレート
        })

        // 参加メンバーの逐次表示イベント
        socket.on("server_to_broadcast_join", function (data) {
            $("#member").append("<div>" + data.name + "</div>");
        });

        socket.on("server_to_client_question", function (data) {
            question = data;
        });

        // スタートボタンクリック時処理
        function start() {
            socket.emit("client_to_server_start");
        };
        // エンドボタンクリック時処理
        /*function end() {
            socket.emit("client_to_server_end", myData.id);
        };*/

        // サーバから全クライアントにゲームスタートイベント
        socket.on("server_to_everybody_start", function () {
            lang_selectOrChange(select.selectedIndex);
            let start_element = document.getElementById("start");
            start_element.remove();
            // htmlに課題表示
            $("#problemStatement").append("<b>" + question.task + "</b>");
            $("#question").show();
            // ゲームタイマースタート
            timeLimitStart();
        });

        // 課題プログラム提出関数
        async function submit() {
            const code = editor.getValue();

            const result = await judge(code, myData.lang, question);
            if (result == 1) {
                // 課題クリア
                alert("課題をクリアしました!");
                socket.emit("client_to_server_clear", myData);
            } else {
                // 課題ノークリア
                alert("課題をクリアしていません。");
            }
        };

        // サーバ->クライアント、クリア後の新しい課題情報受信
        socket.on("server_to_client_clear", function (data) {
            $("#problemStatement").html("<b>" + question.task + "</b>"); // 新しい課題
            // 言語設定
            lang_selectOrChange(data);
            editor.setValue(temps[data]);
        });

        // サーバ->ブロードキャスト、クリア受信
        socket.on("server_to_broadcast_clear", function (data) {
            alert(data + "さんが課題をクリアしました。1分後にコード交換が行われます。")
        });

        // サーバ->全員、交換準備タイマースタート受信
        socket.on("server_to_everybody_preparationTime", () => {
            // 課題・コード交換までの準備タイマースタート
            $("#swap").show();
            swapTimerStart();
        })

        // コード・課題交換受信
        socket.on("server_to_everybody_swapTime", function () {
            myData.code = editor.getValue();
            const swapData = { 'myData': myData, 'question': question };
            socket.emit("client_to_server_swapData", swapData);
        });

        // 他ユーザのコード・課題受信,差し替え
        socket.on("server_to_client_swap", function (data) {
            lang_selectOrChange(data.myData.lang);
            editor.setValue(data.myData.code);
            question = data.question;
            $("#problemStatement").html("<b>" + question.task + "</b>");
            humane.log("swap!"); // swap通知
        });

        // ゲーム終了イベント受信
        socket.on("server_to_everybody_end", function () {
            socket.emit("client_to_server_result", editor.getValue());
            if (!alert("ゲーム終了")) {
                location.href = "/result";
            }
        });

        // 交換までのタイマー処理
        function swapTimerStart() {
            const timer = new easytimer.Timer();

            timer.start({ countdown: true, startValues: { minutes: 1 } });
            $(".countdown #swapTime").html(timer.getTimeValues().toString());

            timer.addEventListener('secondsUpdated', function (e) {
                $(".countdown #swapTime").html(timer.getTimeValues().toString());
            });

            timer.addEventListener("targetAchieved", function (e) {
                $("#swap").hide();
            });
        }

        // ゲームタイマー処理
        function timeLimitStart() {
            const timer = new easytimer.Timer();

            timer.start({ countdown: true, startValues: { hours: 1 } });
            $(".countdown #limitTime").html(timer.getTimeValues().toString());

            timer.addEventListener('secondsUpdated', function (e) {
                $(".countdown #limitTime").html(timer.getTimeValues().toString());
            });

            timer.addEventListener("targetAchieved", function (e) {
                $(".countdown #limitTime").html('ゲーム終了!');
            });
        }
    </script>
</body>

</html>